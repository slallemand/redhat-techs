---
- hosts: aap-demoeda-sup.rhntnx.hpecic.net
  gather_facts: yes
  vars:
    - prometheus_url: 'https://github.com/prometheus/prometheus/releases/download/v2.45.0/prometheus-2.45.0.linux-amd64.tar.gz'
    - grafana_url: 'test'

  tasks:

    - name: Create prometheus group
      ansible.builtin.group:
        name: prometheus
        state: present
    
    - name: Add prometheus user to prometheus group
      ansible.builtin.user:
        name: prometheus
        groups: prometheus
        shell: /bin/bash
        state: present

    - name: Create prometheus data directory
      ansible.builtin.file:
        path: /opt/prometheus
        state: directory
        owner: prometheus
        group: prometheus
        mode: '0775'

    - name: Create prometheus conf directory
      ansible.builtin.file:
        path: /etc/prometheus
        state: directory
        owner: root
        group: prometheus
        mode: '0775'

    - name: Download Prometheus binarie
      ansible.builtin.get_url:
        url: "{{ prometheus_url }}"
        dest: /tmp/prometheus.tar.gz   
        mode: '0440'
        owner: root
        group: root

    - name: Extract Prometheus binarie to conf directory
      ansible.builtin.unarchive:
        src: /tmp/prometheus.tar.gz
        dest: /etc/prometheus/
        remote_src: true
        owner: root
        group: root
        mode: '0775'

    - name: Move file from prometheus directory
      ansible.builtin.shell: mv /etc/prometheus/prometheus-*/* /etc/prometheus/

    - name: Delete old prometheus directory
      ansible.builtin.file:
        path: /etc/prometheus/prometheus-*
        state: absent