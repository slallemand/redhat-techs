---
- name: create VM on OpenShift Virt
  hosts: localhost
  connection: local
  gather_facts: no
  collections:
    - redhat.openshift
    - kubevirt.core

  tasks:
  
  - name: Log in to OpenShift
    redhat.openshift.openshift_auth:
      host: "{{ lookup('env', 'OCP_URL') }}"
      username: "{{ lookup('env', 'OCP_USERNAME') }}"
      password: "{{ lookup('env', 'OCP_PASSWORD') }}"
      validate_certs: false
    register: openshift_auth_results

  - name: print openshift_auth_results var
    ansible.builtin.debug:
      var: openshift_auth_results

  - name: Get a list of all pods from any namespace
    kubernetes.core.k8s_info:
      api_key: "{{ openshift_auth_results.k8s_auth.api_key }}"
      kind: Pod
    register: pod_list
  
  - name: Delete a VirtualMachine
    kubevirt.core.kubevirt_vm:
      api_key: "{{ openshift_auth_results.openshift_auth.api_key }}"
      name: testvm
      namespace: vms
      state: absent

  - name: Log out to OpenShift
    when: openshift_auth_results.openshift_auth.api_key is defined
    redhat.openshift.openshift_auth:
      state: absent
      api_key: "{{ openshift_auth_results.openshift_auth.api_key }}"
